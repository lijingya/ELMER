---
title: "ELMER: An R/Bioconductor Tool Inferring Regulatory Element Landscapes and Transcription Factor Networks Using Methylomes"
author: "Lijing Yao, Ben Berman [aut], Peggy Farnham [aut]Hui Shen [ctb], Peter Laird [ctb], Simon Coetzee [ctb], Tiago Chedraoui Silva [ctb]"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    highlight: haddock
    fig_caption: yes
  BiocStyle::pdf_document2:
    toc: true
    number_sections: true
    toc_depth: 3
    highlight: haddock
    fig_caption: yes        

references:
- id: zhou2016comprehensive
  title: Comprehensive characterization, annotation and innovative use of Infinium DNA methylation BeadChip probes
  author: 
  - family: Zhou, Wanding and Laird, Peter W and Shen, Hui
  given:
  journal: Nucleic Acids Research
  URL: "http://doi.org/10.1093/nar/gkw967"
  DOI: "10.1093/nar/gkw967"
  volume: 159
  number: 3
  pages: 676-690
  issued:
  year: 2016         

- id: tcgabiolinks2
  title: "TCGA Workflow: Analyze cancer genomics and epigenomics data using Bioconductor packages"
  author: 
  - family:  Silva, TC and Colaprico, A and Olsen, C and D'Angelo, F and Bontempi, G and Ceccarelli, M and Noushmehr, H
  given:
  journal: F1000Research
  URL: "http://dx.doi.org/10.12688/f1000research.8923.1"
  DOI: "10.12688/f1000research.8923.1"
  volume: 5
  number: 1542
  issued:
  year: 2016 

- id: tcgabiolinks1
  title: "TCGAbiolinks: an R/Bioconductor package for integrative analysis of TCGA data"
  author: 
  - family:  Colaprico, Antonio and Silva, Tiago C. and Olsen, Catharina and Garofano, Luciano and Cava, Claudia and Garolini, Davide and Sabedot, Thais S. and Malta, Tathiane M. and Pagnotta, Stefano M. and Castiglioni, Isabella and Ceccarelli, Michele and Bontempi, Gianluca and   Noushmehr, Houtan
  given:
  journal: Nucleic Acids Research
  URL: "http://dx.doi.org/10.1093/nar/gkv1507"
  DOI: "10.1093/nar/gkv1507"
  volume: 44
  number: 8
  pages: e71
  issued:
  year: 2016 

vignette: >
  %\VignetteIndexEntry{"ELMER: An R/Bioconductor Tool Inferring Regulatory Element Landscapes and Transcription Factor Networks Using Methylomes"}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(dpi = 300, cache = FALSE)
```

```{r, echo = FALSE,hide=TRUE, message=FALSE,warning=FALSE}
devtools::load_all(".")
dir.create("result")
library(BiocStyle)
```

# Introduction

This document provides an introduction of the R/Biocondcutor  `r Biocpkg("ELMER")` package, which is designed 
to combine DNA methylation and gene expression data from human tissues to infer 
multi-level cis-regulatory networks. `r Biocpkg("ELMER")` uses DNA methylation to 
identify enhancers, and correlates enhancer state with expression of nearby genes 
to identify one or more transcriptional targets. Transcription factor (TF) binding 
site analysis of enhancers is coupled with expression analysis of all TFs to 
infer upstream regulators. This package can be easily applied to TCGA public 
available cancer data sets and custom DNA methylation and gene expression data sets.

ELMER analyses have 5 main steps: 

1. Identify distal enhancer probes on HM450K.
2. Identify distal enhancer probes with significantly different DNA methylation level
in control group and experiment group.
3. Identify putative target genes for differentially methylated distal enhancer probes.
4. Identify enriched motifs for the distal enhancer probes which are significantly 
differentially methylated and linked to putative target gene.
5. Identify regulatory TFs whose expression associate with DNA methylation at motifs.


## Installing and loading ELMER

To install this package, start R and enter

```{r, eval = FALSE}
source("http://bioconductor.org/biocLite.R")
biocLite("ELMER")
```

# Download example data

The following steps can be used to download the example data set for `r Biocpkg("ELMER")`.

```{r, fig.height=6,echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
library(ELMER, quietly = TRUE)
data(elmer.data.example)
data(LUSC_meth_refined)
data(LUSC_RNA_refined)
library(DT)
```


# Quick start: running TCGA example

TCGA.pipe is a function for easily downloading TCGA data and performing all 
the analyses in ELMER. For illustration purpose, we skip the downloading step. 
The user can use the getTCGA function to download TCGA data or
use TCGA.pipe by including "download" in the analysis option.

The following command will do distal enhancer DNA methylation analysis and predict putative
target genes, motif analysis and idnetify regulatory transcription factors.

```{r, fig.height=6,eval=FALSE}
TCGA.pipe("LUSC",
          wd = "./ELMER.example",
          cores = parallel::detectCores()/2,
          permu.size = 300,
          Pe = 0.01,
          analysis = c("distal.probes","diffMeth","pair","motif","TF.search"),
          diff.dir = "hypo",
          rm.chr = paste0("chr",c("X","Y")))
```


# Input data

A Multi Assay Experiment object is the input for all main functions of `r Biocpkg("ELMER")`. 
A [Multi Assay Experiment](https://bioconductor.org/packages/release/bioc/html/MultiAssayExperiment.html)
object can be generated by `createMAE` function. In order to perform all analyses
in `r Biocpkg("ELMER")`. A Multi Assay Experiment needs at least 2 files: a matrix of DNA methylation 
from HM450K platform for multiple samples; a matrix of gene expression for the same samples; 
information for probes on HM450K such as names 
and coordinates will be taken from  [Wanding Zhou annotation](http://zwdzwd.github.io/InfiniumAnnotation)[@zhou2016comprehensive]; 
a gene annotation which will be taken from ensemble database using `r Biocpkg("biomaRt")` 
When TCGA data are used, the sample information will be automatically generated by `createMAE` 
function using `r Biocpkg("TCGAbiolinks")` package [@tcgabiolinks1,@tcgabiolinks2]. 
However sample information should be provided when using custom data.

## DNA methylation data

DNA methylation data feeding to `r Biocpkg("ELMER")` should be a matrix of DNA methylation
beta ($\beta$) value for samples (column) and probes (row) processed from row HM450K 
array data. If TCGA data is used, processed data from GDC website will be downloaded  
and automatically transformed to the matrix by `r Biocpkg("ELMER")`. The processed TCGA 
DNA methylation data were calculated as (M/(M+U)), where M represents the methylated 
allele intensity and U the unmethylated allele intensity. Beta values range from 0 to 1, 
reflecting the fraction of methylated alleles at each CpG in the each tumor; beta values 
close to 0 indicates low levels of DNA methylation and beta values close to 1 
indicates high levels of DNA methylation.

If user have raw HM450K data, these data can be processed by `r Biocpkg("Methylumi")` 
or `r Biocpkg("minfi")` generating DNA methylation beta ($\beta$) value for each CpG site 
and multiple samples. The `getBeta` function in `r Biocpkg("minfi")` can be used to generate a matrix 
of DNA methylation beta ($\beta$) value to feed in `r Biocpkg("ELMER")`. And we recommend to 
save this matrix as `meth.rda` since  `createMAE` 
can read in files by specifying files' path which will help to reduce memory usage.

```{r}
# Example of DNA methylation data input
datatable(Meth[1:10, 1:10], 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)
```

## Gene expression data

Gene expresion data feeding to `r Biocpkg("ELMER")` should be a matrix of gene expression
values for samples (column) and genes (row). Gene expression value can be generated
from different platforms: array or RNA-seq. The row data should be processed by other
software to get gene or transcript level gene expression calls such as mapping by 
[tophat](https://ccb.jhu.edu/software/tophat/index.shtml), 
calling expression value by [cufflink](https://github.com/cole-trapnell-lab/cufflinks), 
[RSEM](https://github.com/deweylab/RSEM) or 
[GenomeStudio](http://www.illumina.com/techniques/microarrays/array-data-analysis-experimental-design/genomestudio.html) for expression array. 
It is recommended to normalize expression data making gene expression 
comparable across samples such as quantile normalization. User can refer TCGA RNA-seq
analysis pipeline to do generate comparable gene expression data. Then transform the 
gene expression values from each sample to the matrix for feeding into `r Biocpkg("ELMER")`.
If users want to use TCGA data, `r Biocpkg("ELMER")` has functions to download the 
RNA-Seq Quantification data(HTSeq-FPKM-UQ)  from GDC website and transform the data to the matrix for feeding 
into `r Biocpkg("ELMER")`. It is recommended to save this matrix as `RNA.rda` since `createMAE` 
can read in files by specifying the path of files which will help to reduce memory usage.

```{r}
# Example of Gene expression data input
datatable(GeneExp[1:10, 1:2], 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)
```


## Sample information

Sample information should be stored as a data.frame object containing sample ID, 
group labels (control and experiment). Sample ID and groups labels are required.
Other information for each sample can be added to this data.frame object.
When TCGA data were used, samples information will be automatically generated by 
`createMAE`  function by specifying option `TCGA=TRUE`. A columns name `TN` will
create the groups Tumor and Normal using the following samples to each group:

Tumor samples are:   
  *   Primary solid Tumor
  *   Recurrent Solid Tumor
  *   Primary Blood Derived Cancer - Peripheral Blood
  *   Recurrent Blood Derived Cancer - Bone Marrow
  *   Additional - New Primary
  *   Metastatic
  *   Additional Metastatic
  *   Human Tumor Original Cells
  *   Primary Blood Derived Cancer - Bone Marrow
  
Normal samples:
  * Blood Derived Normal
  * Solid Tissue Normal
  * Buccal Cell Normal
  * EBV Immortalized Normal
  * Bone Marrow Normal

```{r, message=FALSE}
library(MultiAssayExperiment)
data <- createMAE(exp = GeneExp, 
                  met = Meth,
                  met.platform = "450K",
                  genome = "hg19",
                  save = FALSE,
                  TCGA = TRUE)
data
datatable(as.matrix(colData(data)[,c("patient","definition","TN")]),
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)

# Adding sample information for non TCGA samples
# You should have two objects with one for DNA methylation and 
# one for gene expression. They should have the same number of samples and the names of the 
# sample in the gene expression object and in hte DNA methylation matrix 
# should be the same
not.tcga.exp <- GeneExp # 234 samples
colnames(not.tcga.exp) <- substr(colnames(not.tcga.exp),1,15)
not.tcga.met <- Meth # 268 samples
colnames(not.tcga.met) <- substr(colnames(not.tcga.met),1,15)
# Number of samples in both objects (234)
table(colnames(not.tcga.met) %in% colnames(not.tcga.exp)) 

# Our sample information must have as row names the samples information
phenotype.data <- data.frame(row.names = colnames(not.tcga.exp), 
                             samples = colnames(not.tcga.exp), 
                             group = c(rep("group1", ncol(GeneExp)/2),
                                       rep("group2", ncol(GeneExp)/2)))

data.hg19 <- createMAE(exp = not.tcga.exp, 
                       met =  not.tcga.met, 
                       TCGA = FALSE, 
                       met.platform = "450K",
                       genome = "hg19", 
                       colData = phenotype.data)
data.hg19

# The samples that does not have data for both DNA methylation and Gene exprssion will be removed even for the phenotype data
phenotype.data <- data.frame(row.names = colnames(not.tcga.met), 
                             samples = colnames(not.tcga.met), 
                             group = c(rep("group1", ncol(Meth)/4),
                                       rep("group2", ncol(Meth)/4),
                                       rep("group3", ncol(Meth)/4),
                                       rep("group4", ncol(Meth)/4)))

data.hg38 <- createMAE(exp = not.tcga.exp, 
                       met =  not.tcga.met, 
                       TCGA = FALSE, 
                       save = FALSE,
                       met.platform = "450K",
                       genome = "hg38", 
                       colData = phenotype.data)
data.hg38
datatable(as.matrix(colData(data.hg38)[1:20,]),
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)
```

## Probe information

Probe information is stored as a GRanges object containing the coordinates 
of each probe on the DNA methylation array and names of each probe. 
The default probe information is fetching from  [Wanding Zhou annotation](http://zwdzwd.github.io/InfiniumAnnotation)[@zhou2016comprehensive]

```{r, message=FALSE}
library(SummarizedExperiment, quietly = TRUE)
rowRanges(getMet(data))[1:3,1:8]
```

## Gene information

Gene information is stored as a GRanges object containing coordinates of 
each gene, gene id, gene symbol and gene isoform id. The default gene information 
is the ensembl gene annotation fetching from `r Biocpkg("biomaRt")` by `r Biocpkg("ELMER")` 
function.

```{r}
rowRanges(getExp(data))
```

##  Multi Assay Experiment object 

A Multi Assay Experiment object from the `r Biocpkg("MultiAssayExperiment")` package is the input for multiple main functions of `r Biocpkg("ELMER")`. 
It contains the above components and making a Multi Assay Experiment object by `createMAE` function will keep each
component consistent with each other. For example, althougth DNA methylation and gene 
expression matrixes have different rows (probe for DNA methylation and gene id for gene
expression), the column (samples) order should be same in the two matrixes. The `createMAE`
function will keep them consistent when it generates the  Multi Assay Experiment object.


```{r, message=FALSE}
data <- createMAE(exp = GeneExp, 
                  met = Meth,
                  genome = "hg19",
                  save = FALSE,
                  met.platform = "450K",
                  TCGA = TRUE)

# For TGCA data 1-12 represents the patient and 1-15 represents the sample ID (i.e. primary solid tumor samples )
all(substr(colnames(getExp(data)),1,15) == substr(colnames(getMet(data)),1,15))

# See sample information for data
datatable(as.matrix(colData(data)[colData(data)$sample == "TCGA-43-3394-11A",]),
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)

# See sample names for each experiment
sampleMap(data)

```

You can also use your own data and annotations to create  Multi Assay Experiment object. 

```{r, message=FALSE}
# NON TCGA example: matrices has diffetrent column names
 gene.exp <- DataFrame(sample1 = c("ENSG00000141510"=2.3,"ENSG00000171862"=5.4),
                        sample2 = c("ENSG00000141510"=1.6,"ENSG00000171862"=2.3))
dna.met <- DataFrame(sample1 = c("cg14324200"=0.5,"cg23867494"=0.1),
                     sample2 =  c("cg14324200"=0.3,"cg23867494"=0.9))
sample.info <- DataFrame(sample.type = c("Normal", "Tumor"))
rownames(sample.info) <- colnames(gene.exp)

mae <- createMAE(exp = gene.exp,
                 met = dna.met,
                 save = FALSE,
                 met.platform = "450K",
                 colData = sample.info, 
                 genome = "hg38") 

# NON TCGA example: matrices has diffetrent column names
rownames(sample.info) <- c("sample1","sample2")

sampleMap <- DataFrame(primary = c("sample1","sample1","sample2","sample2"), 
                       colname = c("sample1.exp","sample1.met","sample2.exp","sample2.met"))

mae <- createMAE(exp = gene.exp, 
                 met = dna.met, 
                 sampleMap = sampleMap, 
                 colData = sample.info, 
                 save = FALSE,
                 met.platform = "450K",
                 genome = "hg38") 
```

# Illustration of ELMER analysis steps

The example data set is a subset of chromosome 1 data from TCGA LUSC.
ELMER analysis have 5 main steps which are shown below individually. `TCGA.pipe` 
introduced above is a pipeline combining all 5 steps and producing all
results and figures. 

## Selection of probes within biofeatures

This step is to select HM450K/EPIC probes, which locate far from TSS (at least 2Kb away) 
and within distal enhancer regions. These probes are called distal enhancer probes.
For distal enhancer regions, we constructed a comprehensive list of putative enhancers 
combining REMC, ENCODE and FANTOM5 data. Enhancers were identified using ChromHMM 
for 98 tissues or cell lines from REMC and ENCODE project and we used the union of 
genomic elements labeled as EnhG1, EnhG2, EnhA1 or EnhA2 (representing intergenic and 
intragenic active enhancers) in any of the 98 cell types, resulting in a total of 
389,967 non-overlapping enhancer regions. Additionally, FANTOM5 enhancers (43,011) 
identified by eRNAs for 400 distinct cell types were added to this list. 
Be default, this comprehensive list of putative enhancer and TSS annotated by GENCODE,
which is programatically accessed using `r Biocpkg("biomaRt")` to get its last version,
will be used to select distal enhancer probes. But user can use their 
own TSS annotation or features such as H3K27ac ChIP-seq in a certain cell line.


```{r, message=FALSE}
#get distal enhancer probes that are 2kb away from TSS and overlap with REMC and FANTOM5 
#enhancers on chromosome 1
Probe <- get.feature.probe(genome = "hg19", met.platform = "450K", rm.chr = paste0("chr",c(2:22,"X","Y")))
save(Probe,file="result/probeInfo_feature_distal.rda")
```

## Identifying differentially methylated probes

This step is to identify DNA methylation changes at distal enhancer probes which is
carried out by function `get.diff.meth`.    

### Description 

For each enhancer probe, function first ranked experiment samples and control samples 
by their DNA methylation beta values. To identify hypomethylated probes, function 
compared the lower control quintile (20% of control samples with the lowest methylation) 
to the lower experiment quintile (20% of experiment samples with the lowest methylation), 
using an unpaired one-tailed t-test. Only the lower quintiles were used because we 
did not expect all cases to be from a single molecular subtype, and we sought to 
identify methylation changes within cases from the same molecular subtype. 20% (i.e. a quintile) 
was picked as a cutoff to include high enough sample numbers to yield t-test p-values 
that could overcome multiple hypothesis correction, yet low enough to be able to 
capture changes in individual molecular subtypes occurring in 20% or more of the cases.
This number can be set arbitrarily as an input to the get.diff.meth function in the 
`r Biocpkg("ELMER")`, and should be tuned based on sample sizes in individual studies. 
The one tailed t-test was used to rule out the null hypothesis: $\mu experiment \geq \mu control$, 
where $\mu$experiment is the mean methylation within the lowest experiment quintile and $\mu$control 
is the mean within the lowest control quintile. Raw p-values were adjusted for multiple
hypothesis testing using the Benjamini-Hochberg method, and probes were selected 
when they had adjusted p-value less than 0.01. For additional stringency, probes 
were only selected if the methylation difference: $\Delta = \mu experiment - \mu control$ was 
greater than 0.3. The same method was used to identify hypermethylated probes, 
except we used upper experiment quintile and upper control quintile, and chose 
the opposite tail in the t-test. 

If save parameter of get.diff.meth is true, two cvs files will be saved. If false,
a data frame with the same content as the second file mentioned below will be reported.

The first file contains all statistic results for all probes which were fed into the 
function. Based on this file, user can change different P value or sig.dir cutoff 
to select the significant results without redo the analysis.

The second file contains statistic results for the probes that pass the significant
criteria (P value and sig.dir).

Both files contain four columns: probe, pvalue, ExperimentMinControl, adjust.p.

1. probe: the name of probes.
2. pvalue: the raw P value from t-test.
3. ExperimentMinControl:  methylation difference $\Delta$.
4. adjust.p: adjusted P value for t-test.

### Arguments
The main arguments of this function are:

| Argument | Description |
|------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| data | A `multiAssayExperiment` with DNA methylation and Gene Expression data. See `createMAE` function. |
| diff.dir |  A character can be "hypo" or "hyper", showing differential methylation dirction.  It can be "hypo" which is only selecting hypomethylated probes;  "hyper" which is only selecting hypermethylated probes |
| cores | A interger which defines the number of cores to be used in parallel process. Default is 1: no parallel process. |
| percentage |  A number ranges from 0 to 1 specifying the percentage of samples from group1 and group2 that are used to identify the differential methylation. Default is 0.2 because we did not expect all cases to be from a single molecular subtype.But, If you are working with molecular subtypes please set it to 1. |
| pvalue | A number specifies the significant P value (adjusted P value by BH) cutoff for selecting significant hypo/hyper-methylated probes. Default is 0.01 |
| group.col | A column defining the groups of the sample. You can view the available columns using: `colnames(MultiAssayExperiment::colData(data))`. |
| group1 | A group from group.col. ELMER will run group1 vs group2. That means, if direction is hyper, get probes hypermethylated in group 1 compared to group 2. |
| group2 | A group from group.col. ELMER will run group1 vs group2. That means, if direction is hyper, get probes hypermethylated in group 1 compared to group 2. |
| test | Statistical test to be used. Options: t.test (DEFAULT), wilcox.test |
| sig.dif | A number specifies the smallest DNA methylation difference as a cutoff for selecting significant hypo/hyper-methylated probes. Default is 0.3. |
| dir.out | A path specify the directory for outputs. Default is is current directory. |
| save | A logic. When TRUE, two getMethdiff.XX.csv files will be generated (see detail) |

### Code example
```{r,eval=TRUE, message=FALSE}
library(MultiAssayExperiment)
data <- createMAE(exp = GeneExp, 
                  met = Meth,
                  save = FALSE,
                  met.platform = "450K",
                  genome = "hg19",
                  TCGA = TRUE)
save(data,file = "result/mae.rda")
datatable(as.matrix(colData(data)[1:5,]), 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)

sig.diff <- get.diff.meth(data, 
                          group.col = "definition",
                          group1 =  "Primary solid Tumor",
                          group2 = "Solid Tissue Normal",
                          percentage = 0.2,
                          sig.dif = 0.3,
                          diff.dir = "hypo", # Search for hypomethylated probes in group 1
                          cores = parallel::detectCores()/2, 
                          dir.out ="result", 
                          pvalue = 0.01)

datatable(sig.diff, 
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)
# get.diff.meth automatically save output files. 
# getMethdiff.hypo.probes.csv contains statistics for all the probes.
# getMethdiff.hypo.probes.significant.csv contains only the significant probes which
# is the same with sig.diff
dir(path = "result", pattern = "getMethdiff")  
```

### Percentage: Dealing with molecular subytpes 

As stated before the argument `percentage` (a number ranging from 0 to 1) controls 
the number of samples to be used from both groups when you are comparing the DNA methylation level at each probe.
When comparing Primary Solid tumor samples versus Normal tissue samples only the lower quintiles were used because we 
did not expect all cases to be from a single molecular subtype, and we sought to 
identify methylation changes within cases from the same molecular subtype.
But if you are dealing already with subtypes it is better to set `percentage` to 1.

The code example below highlight some different probes founds when using 100\% or 20\%.

```{r  results="hide",eval=TRUE, message=FALSE}
# We will evaluate the different probes found using different percentage values.
groupCol <- "subtype_Expression.Subtype"
group1 <- "classical"
group2 <- "secretory"

# For each probe use lower 20% samples
sig.diff.20 <- get.diff.meth(data, 
                             group.col = groupCol,
                             group1 = group1,
                             group2 = group2,
                             percentage = 0.2,
                             sig.dif = 0.3,
                             diff.dir = "hypo",
                             pvalue = 0.01)

# For each probe use all samples
sig.diff.100 <- get.diff.meth(data, 
                              group.col = groupCol,
                              group1 = group1,
                              group2 = group2,
                              percentage = 1.0,
                              sig.dif = 0.3,
                              diff.dir = "hypo", 
                              pvalue = 0.01)
```
```{r  eval=TRUE, message=FALSE,fig.height=4, fig.width=4, warning=FALSE}
# Which probes were found with 20% of samples and not with 100%
probe <- sig.diff.20[which(!sig.diff.20$probe %in% sig.diff.100$probe),"probe"]
metBoxPlot(data,groupCol,group1,group2,probe = probe[1],percentage = 0.2,
           diff.dir = "hypo", title = "probes were found with 20% of samples and not with 100%")
```
```{r  eval=TRUE, message=FALSE,fig.height=4, fig.width=4, warning=FALSE}
# Which probes were found with 100% of samples and not with 20%
probe <- sig.diff.100[which(!sig.diff.100$probe %in% sig.diff.20$probe),"probe"]
metBoxPlot(data,groupCol,group1,group2,probe = probe[1],percentage = 0.2, 
           diff.dir = "hypo", title = "probes were found with 100% of samples and not with 20%")
```

## Identifying putative probe-gene pairs

This step is to link enhancer probes with mehtylation changes to target genes with expression
changes and report the putative target gene for selected probes. This is carried out
by function get.pair. 

### Description
First, the fucntion get.pair for additional stringency and to avoid correlations due to non-cancer contamination, 
selects only those enhancer probes that had differential methylation as defined above, 
and where at least 5 % of all samples (combining tumor and normal) had beta values > 0.3.
 We usually call locus unmethylated when the methylation value < 0.3 and methylated 
 when the methylation value > 0.3. 
Basically, this step will make sure we have at least a percentage of beta values 
lesser than K and n percentage of beta values greater K. 
For example, if percentage is 5\%, the number of samples 100 and `K = 0.3`, 
this filter will select probes that we have at least 5 (5\% of 100\%) samples have beta 
values > 0.3 and at least 5 samples have beta values < 0.3.
This filter is important as true promoters and enhancers usually have a pretty low 
value (of course purity can screw that up).  
we often see lots of PMD probes across the genome with intermediate values like 0.4.  
Choosing a value of 0.3 will certainly give some false negatives, but not compared
to the number of false positives we thought we might get without this filter.
Please see the documentation for the function `preAssociationProbeFiltering`.

After, for each distal probe with differential methylation and passing 
this filter, the closest 10 upstream 
genes and the closest 10 downstream genes were tested for correlation between 
methylation of the probe and expression of the gene. To select these genes, 
the probe-gene distance was defined as the distance from the probe to a transcription 
start site specified by the GENCODE gene annotation. Thus, exactly 20 statistical 
tests were performed for each probe, as follows. For each probe-gene pair, 
the samples (all experiment samples and control samples) were divided into two 
groups: the M group, which consisted of the upper methylation quintile (the 20%
of samples with the highest methylation at the enhancer probe), and the U group, 
which consisted of the lowest methylation quintile (the 20% of samples with the 
lowest methylation.) The 20% ile cutoff is a configurable parameter in the `get.pair`.
Default is 20% as a balance, which would allow us to identify changes in a 
molecular subtype making up a minority (i.e. 20%) of cases, while also yielding 
enough statistical power to make strong predictions. For each candidate probe-gene pair, 
the Mann-Whitney U test was used to test the null hypothesis that overall gene 
expression in group M was greater or equal than that in group U. 
This non-parametric test was used in order to minimize the effects 
of expression outliers, which can  occur across a very wide dynamic range. 
For each probe-gene pair tested, the raw p-value `Pr` was corrected for multiple 
hypothesis using a permutation approach as follows (implemented in the `get.permu`
function of the `r Biocpkg("ELMER")` package).
The gene in the pair was held constant, and x random methylation probes were 
used to perform the same one-tailed U test, generating a set of x permutation
p-values (`Pp`). We chose the x random probes only from among those that were 
"distal" (greater than 2kb from an annotated transcription start site), in order 
to make these null-model probes qualitatively similar to the probe being tested. 
An empirical p-value Pe value was calculated using the following formula 
(which introduces a pseudo-count of 1):

$$Pe = \frac{num(Pp \leq Pr)+ 1}{x+1}$$

This step is the most time consuming step since it requires a large amount calculations 
for permutation. The greater the permutation time is, the longer it will take. 
It is recommended to use multiple cores for this step. 10,000 permutations is recommended 
if high confidence results are desired but it may cost some hours.

If save parameter of get.pair function is true, two cvs files will be output. 
If save parameter is false, a data frame with the same contect as the second file
mentioned as below will be output.

The first file contains all statistic results for all probe-gene pairs. Based on this file, user 
can change different P value or sig.dir cutoff to select the significant results
without redo the analysis.

The second file contains statistic results for the probes that pass the significant criteria (Pe).

Both files contain four columns: probe, GeneID, Symbol, Distance, Sides, Raw.p, Pe.

1. Probe: the name of probes.
2. GeneID and Symbol is for the genes which are linked to the probe.
3. Distance: the distance between the probe and the gene.
4. Sides: right (R) side or left (L) side of probe and the rank based on distance.
For example, L3 means the gene is the number 3 closest gene from the left side of the probe.
5. Raw.p:  P value from the Mann-Whitney U test for each pair.
6. Pe: the empirical P value for each pair.

### Arguments

The main arguments of this function are:

| Argument          | Description                                                                                                                                                                                                                                                                                                                                                         |
|-------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| data              | A multiAssayExperiment with DNA methylation and Gene Expression data. See createMAE function.                                                                                                                                                                                                                                                                       |
| nearGenes         | Can be either a list containing output of GetNearGenes function or path of rda file containing output of GetNearGenes function.                                                                                                                                                                                                                                     |
| percentage        | A number ranges from 0 to 0.5 specifying the percentage of samples used to link probes to genes. Default is 0.2.                                                                                                                                                                                                                                                    |
| permu.size        | A number specify the times of permuation. Default is 10000.                                                                                                                                                                                                                                                                                                         |
| permu.dir         | A path where the output of permutation will be.                                                                                                                                                                                                                                                                                                                     |
| pvalue            | A number specify the raw p-value cutoff for defining signficant pairs. Default is 0.05. It will select the significant P value cutoff before calculating the empirical p-values.                                                                                                                                                           |
| Pe                | A number specify the empirical p-value cutoff for defining signficant pairs. Default is 0.001.                                                                                                                                                                                                                        |
| dir.out           | A path specify the directory for outputs. Default is current directory                                                                                                                                                                                                                                                                                              |
| diffExp           | A logic. Default is FALSE. If TRUE, t test will be applied to test whether putative target gene are differentially expressed between two groups.                                                                                                                                                                                                                    |
| group.col         | A column defining the groups of the sample. You can view the available columns using: `colnames(MultiAssayExperiment::colData(data))`.                                                                                                                                                                                                                                  |
| cores             | A interger which defines number of core to be used in parallel process. Default is 1: don't use parallel process.                                                                                                                                                                                                                                                   |
| filter.probes     | Should filter probes by selecting only probes that have at least a certain number of samples below and above a certain cut-off. See `preAssociationProbeFiltering` function.                                                                                                                                                                                          |
| filter.portion    | A number specify the cut point to define binary methlation level for probe loci. Default is 0.3. When beta value is above 0.3, the probe is methylated and vice versa. For one probe, the percentage of methylated and unmethylated samples should be above filter.percentage value. Only used if filter.probes is TRUE. See preAssociationProbeFiltering function. |
| filter.percentage | Minimum percentage of samples to be considered in methylated and unmethylated for the filter.portion option. Default 5%. Only used if filter.probes is TRUE. See preAssociationProbeFiltering function.                                                                                                                                                             |
| label             | A character labels the outputs.                                                                                                                                                                                                                                                                                                                                     |
| save              | Two files will be saved if save is true: getPair.XX.all.pairs.statistic.csv and getPair.XX.pairs.significant.csv (see detail).                                                                                                                                                                                                                                      |
### Code example
```{r,eval=TRUE, message=FALSE}
### identify target gene for significantly hypomethylated probes.

Sig.probes <- read.csv("result/getMethdiff.hypo.probes.significant.csv",
                       stringsAsFactors=FALSE)[,1]  
head(Sig.probes)  # significantly hypomethylated probes

## Collect nearby 20 genes for Sig.probes
nearGenes <- GetNearGenes(data = data, probes = Sig.probes, cores = parallel::detectCores()/2)

## Identify significant probe-gene pairs
Hypo.pair <- get.pair(data = data,
                      nearGenes = nearGenes,
                      permu.dir = "result/permu",
                      permu.size = 100, # Please set to 100000 to get significant results
                      pvalue = 0.05,   
                      Pe = 0.01,       # Please set to 0.001 to get significant results
                      filter.probes = TRUE, # See preAssociationProbeFiltering function
                      filter.percentage = 0.05,
                      filter.portion = 0.3,
                      dir.out = "result",
                      cores = parallel::detectCores()/2,
                      label = "hypo")

datatable(Hypo.pair, ## significant probe-gene pairs
          options = list(scrollX = TRUE, keys = TRUE, pageLength = 5), 
          rownames = TRUE)
# get.pair automatically save output files. 
#getPair.hypo.all.pairs.statistic.csv contains statistics for all the probe-gene pairs.
#getPair.hypo.pairs.significant.csv contains only the significant probes which is 
# same with Hypo.pair.
dir(path = "result", pattern = "getPair") 
```


## Motif enrichment analysis on the selected probes

This step is to identify enriched motif in a set of probes which is carried out by
function `get.enriched.motif`.

### Description

The build in data Probes.motif is generated using HOMER with a p-value < 1eâ€“4 
to scan a +/- 250bp region around each probe using HOmo sapiens 
COmprehensive MOdel COllection [http://hocomoco.autosome.ru/](HOCOMOCO) v10  position
weight matrices (PWMs). HOCOMOCO offers 601 PMWs each has a quality rating from A to D where 
A represents motifs with the highest confidence, and D motifs only weakly describe the pattern with a 
limited applications for quantitative analyses. By default only quality A and B will be used for the 
Motif enrichment analysis, but the Minimum quality score can be selected by the user.
(Addtional information [http://hocomoco.autosome.ru/help#description_quality_score](Source)  
[http://nar.oxfordjournals.org/content/44/D1/D116.full#sec-8](More information)). 

For each probe set tested (i.e. the list of gene-linked hypomethylated probes in a given experiment 
group), a motif enrichment Odds Ratio and a 95% confidence interval were 
calculated using following formulas:
$$ p= \frac{a}{a+b} $$
$$ P= \frac{c}{c+d} $$
$$ Odds\quad  Ratio = \frac{\frac{p}{1-p}}{\frac{P}{1-P}} $$
$$ SD = \sqrt{\frac{1}{a}+\frac{1}{b}+\frac{1}{c}+\frac{1}{d}} $$
$$ lower\quad boundary\quad of\quad  95\%\quad  confidence\quad  interval = \exp{(\ln{OR}-SD)} $$

where a is the number of probes within the selected probe set that contain one 
or more motif occurrences; b is the number of probes within the selected probe 
set that do not contain a motif occurrence; c and d are the same counts within 
the entire enhancer probe set. A probe set was considered significantly enriched 
for a particular motif if the 95% confidence interval of the Odds Ratio was 
greater than 1.1 (specified by option lower.OR, 1.1 is default), and the motif 
occurred at least 10 times (specified by option min.incidence. 10 is default) in 
the probe set. As described in the text, Odds Ratios were also used for ranking 
candidate motifs. 

There will be two results if save parameter of get.enriched.motif is true. When save is false, 
only second result mentioned below will be reported.

The first one is a csv file. This file contains the Odds Ratio and 95% confidence 
interval for these Odds Ratios which pass the signficant cutoff (lower.OR and 
min.incidence). It contains 5 columns: motif, NumOfProbes, OR, lowerOR and upperOR.

1. motif: the name of motif.
2. NumOfProbes: the number of probes with this motif in the given set of probes
corresponding to min.incidence option.
3. OR: the Odds Ratio.
4. lowerOR: the lower boundary of 95% confidence interval.
5. upperOR: the upper boundary of 95% confidence interval.

The second file is a rda file listing each enriched motif and the probes containing
the motif.

### Arguments

The main arguments of this function are:

| Argument | Description |
|-------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| data | A multi Assay Experiment from  createMAE function. If set and probes.motif/background probes are missing this will be used to get this other two arguments correctly. This argument is not require, you can set probes.motif and the backaground.probes manually. |
| probes.motif | A matrix contains motifs occurrence within probes regions. Probes.motif in ELMER.data will be used if probes.motif is missing (detail see Probes.motif.hg19.450K). |
| probes | A vector lists the name of probes to define the set of probes in which motif enrichment OR and confidence interval will be calculated. |
| min.motif.quality | Minimum motif quality score to consider. Possible valules: A, B, C , D, AS (A and S), BS (A, B and S), CS (A, B , C and S), DS (all - default) Description: Each PWM has a quality rating from A to D where A represents motifs with the highest confidence, and D motifs only weakly describe the pattern with a limited applications for quantitative analyses. Special S quality marks the single-box motifs (secondary motif). Source: http://hocomoco.autosome.ru/help#description_quality_score More information: http://nar.oxfordjournals.org/content/44/D1/D116.full#sec-8 |
| background.probes | A vector lists name of probes which are considered as background for motif.enrichment calculation (see detail). |
| lower.OR | A number specifies the smallest lower boundary of 95% confidence interval for Odds Ratio. The motif with higher lower boudnary of 95% confidence interval for Odds Ratio than the number are the significantly enriched motifs (detail see reference). |
| min.incidence | A non-negative integer specifies the minimum incidence of motif in the given probes set. 10 is default. |
| dir.out | A path. Specifies the directory for outputs. Default is current directory |
| label | A character. Labels the outputs such as "hypo", "hyper" |
| save | If save is TURE, two files will be saved: getMotif.XX.enriched.motifs.rda and getMotif.XX.motif.enrichment.csv (see detail). |

### Code example
```{r,eval=TRUE, message=FALSE}
## identify enriched motif for significantly hypomethylated probes which 
##have putative target genes.

Sig.probes.paired <- read.csv("result/getPair.hypo.pairs.significant.csv",
                              stringsAsFactors=FALSE)[,1]  
head(Sig.probes.paired) # significantly hypomethylated probes with putative target genes

enriched.motif <- get.enriched.motif(data = data,
                                     min.motif.quality = "B", # Default: options A, B, C, D
                                     probes = Sig.probes.paired, 
                                     dir.out = "result", 
                                     label = "hypo",
                                     min.incidence = 10,
                                     lower.OR = 1.1)
names(enriched.motif)  # enriched motifs
head(enriched.motif["P73_HUMAN.H10MO.A"]) ## probes in the given set that have TP53 motif.

# get.enriched.motif automatically save output files. 
# getMotif.hypo.enriched.motifs.rda contains enriched motifs and the probes with the motif. 
# getMotif.hypo.motif.enrichment.csv contains summary of enriched motifs.
dir(path = "result", pattern = "getMotif") 

# motif enrichment figure will be automatically generated.
dir(path = "result", pattern = "motif.enrichment.pdf") 
```


## Identifying regulatory TFs

This step is to identify regulatory TF whose expression associates with TF binding motif 
DNA methylation which is carried out by function get.TFs.

### Description
For each motif considered to be enriched within a particular probe set, function will
compare the average DNA methylation at all distal enhancer probes within +/- 100bp 
of a motif occurrence, to the expression of human TFs. A statistical test 
was performed for each motif-TF pair, as follows. The samples (all control and 
experiment samples) were divided into two groups: the M group, which consisted 
of the 20% of samples with the highest average methylation at all motif-adjacent 
probes, and the U group, which consisted of the 20% of samples with the lowest 
methylation. The 20th percentile cutoff is a parameter to the get.TFs function 
and was set to allow for identification of molecular subtypes present in 20% of 
cases. For each candidate motif-TF pair, the Mann-Whitney U test was used to test 
the null hypothesis that overall gene expression in group M was greater or equal 
than that in group U. This non-parametric test was used in order to minimize the 
effects of expression outliers, which can occur across a very wide dynamic range. 
For each motif tested, this resulted in a raw p-value (Pr) for each of the human TFs.
All TFs were ranked by the -log10(Pr), and those falling within the top 5% of 
this ranking were considered candidate upstream regulators. The best upstream 
TFs which are known recognized the motif was automatically extracted as putative 
regulatory TFs.

If save parameter of get.TFs function is true, two files will be generated. 
If save parameter is false, only a data frame containing the same content 
with the first file mentioned below will be output.

The first one csv file. This file contain the regulatory TF significantly 
associate with average DNA methylation at particular motif sites. It contains 6 
columns: motif, top.potential.TF.family, top.potential.TF.subfamily, 
potential.TFs.family, potential.TFs.subfamily and top_5percent.

1. motif: the names of motif.
2. top.potential.TF.family: the highest ranking upstream TFs which are known recognized the motif. First item in potential.TFs.family
3. top.potential.TF.subfamily: the highest ranking upstream TFs which are known recognized the motif. First item in potential.TFs.subfamily
4. potential.TFs.family: TFs which are within top 5% list and are known recognized the motif  (considering family classification).
5. potential.TFs.subfamily: TFs which are within top 5% list and are known recognized the motif (considering subfamily classification).
6. top_5percent: all TFs which are within top 5% list.

The second file is rda file. This file contains a matrix storing the statistic 
results for associations between TFs (row) and average DNA methylation 
at motifs (column). This matrix can be use to generate TF ranking plots by function
TF.rank.plot.

### Arguments


The main arguments of this function are:

| Argument | Description |
|--------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| data | A multiAssayExperiment with DNA methylation and Gene Expression data. See createMAE function. |
| enriched.motif | A list containing output of get.enriched.motif function or a path of XX.rda file containing output of get.enriched.motif function. |
| TFs | A data.frame containing TF GeneID and Symbol or a path of XX.csv file containing TF GeneID and Symbol. If missing, human.TF list will be used (human.TF data in ELMER.data). For detail information, refer the reference paper. |
| motif.relevant.TFs | A list containing motif as names and relavent TFs as contents for each list element or a path of XX.rda file containing a list as above. If missing, TFClass classification will be used. See function createMotifRelevantTfs|
| percentage | A number ranges from 0 to 0.5 specifying the percentage of samples of control and experimental groups used to link probes to genes. Default is 0.2. |
| dir.out | A path specifies the directory for outputs of get.pair function. Default is current directory |
| label | A character labels the outputs. |
| cores | A interger which defines the number of cores to be used in parallel process. Default is 1: no parallel process. |
| save | A logic. If save is ture, two files will be saved: getTF.XX.significant.TFs.with.motif.summary.csv and getTF.hypo.TFs.with.motif.pvalue.rda (see detail). If save is false, a data frame contains the same content with the first file. |

### Code example
```{r results='hide', echo=TRUE, message=FALSE, warning=FALSE}
## identify regulatory TF for the enriched motifs
TF <- get.TFs(data = data, 
              enriched.motif = enriched.motif,
              dir.out = "result", 
              cores = 1, 
              label = "hypo")

# get.TFs automatically save output files. 
# getTF.hypo.TFs.with.motif.pvalue.rda contains statistics for all TF with average 
# DNA methylation at sites with the enriched motif.
# getTF.hypo.significant.TFs.with.motif.summary.csv contains only the significant probes.
dir(path = "result", pattern = "getTF")  

# TF ranking plot based on statistics will be automatically generated.
dir(path = "result/TFrankPlot", pattern = "pdf") 
```

# Generating figures
## Scatter plots
Generate scatter plots for one probes' nearby 20 gene expression vs DNA methylation at this probe. Figure \ref{fig:figure1}

```{r results='hide', echo=TRUE, message=FALSE,warning=FALSE, fig.cap="Each scatter plot shows the methylation level of an example  probe cg19403323 in all LUSC samples plotted against the expression of one of  20 adjacent genes."}
scatter.plot(data,
             byProbe = list(probe = c("cg19403323"), geneNum = 20), 
             category = "definition", 
             save = FALSE) 
```

###  Scatter plot of one pair
Generate a scatter plot for one probe-gene pair. Figure \ref{fig:figure2}

```{r,eval=TRUE, fig.cap="Scatter plot shows the methylation level of an example probe cg19403323 in all LUSC samples plotted against the expression of the putative  target gene SYT14."}
scatter.plot(data,
             byPair = list(probe = c("cg19403323"), gene = c("ENSG00000143469")), 
             category = "definition", save = TRUE, lm_line = TRUE) 
```

###  TF expression vs. average DNA methylation
Generate scatter plot for TF expression vs average DNA methylation of the sites 
with certain motif. Figure \ref{fig:figure3}

```{r,eval=TRUE, fig.cap="Each scatter plot shows the average  methylation level of sites with the TP53 motif in all LUSC samples plotted against the expression of the transcription factor TP53, TP63, TP73 respectively."}
load("result/getMotif.hypo.enriched.motifs.rda")
scatter.plot(data,
             byTF = list(TF = c("TP53","TP63","TP73"),
                         probe = enriched.motif[["P73_HUMAN.H10MO.A"]]), 
             category = "definition",
             save = TRUE, lm_line = TRUE)
```

## Schematic plot
Schematic plot shows a breif view of linkages between genes and probes.

### Nearby Genes
Generate schematic plot for one probe with 20 nearby genes and label 
the gene significantly linked with the probe in red. Figure \ref{fig:figure4}


```{r results='hide', eval=TRUE, fig.cap="The schematic plot shows probe colored in blue and the location of nearby 20 genes. The genes significantly linked to the probe  were shown in red.", message=FALSE, warning=FALSE}
schematic.plot(pair = Hypo.pair, 
               data = data,
               group.col = "definition",
               byProbe = "cg25312122",
               save = FALSE)
```

### Nearby Probes
Generate schematic plot for one gene with the probes which the gene is significantly 
linked to. Figure \ref{fig:figure5}

```{r,eval=TRUE, fig.cap="The schematic plot shows the gene colored in red and all blue colored probes, which are significantly linked to the  expression of this gene."}
schematic.plot(pair = Hypo.pair, data = data,   group.col = "definition", byGene = "ENSG00000143469", save = FALSE)
```

## Motif enrichment plot
Motif enrichment plot shows the enrichment levels for the selected motifs. Figure\ref{fig:figure6}

```{r,eval=TRUE,fig.cap="The plot shows the Odds Ratio (x axis) for the selected motifs with OR above 1.3 and lower boundary of OR above 1.3. The range shows the 95% confidence interval for each Odds Ratio."}
motif.enrichment.plot(motif.enrichment="result/getMotif.hypo.motif.enrichment.csv", 
                      significant=list(OR=1.3,lowerOR=1.3), 
                      label="hypo", save=TRUE)  ## different signficant cut off.
```

## TF ranking plot
TF ranking plot shows statistic -log10(P value) assessing the anti-correlation level 
of TFs expression level with average DNA methylation level at sites with a given motif. Figure \ref{fig:figure7}
By default, the top 3 associated TFs and the TF family members (dots in red) that are associated with that specific motif  are labeled in the plot.
But there is also a option show highlight only TF sub-family members (TCClass database classification)

```{r,eval=TRUE,fig.cap="Shown are TF ranking plots based on the score (-log(P value)) of association between TF expression and DNA methylation of the TP53 motif in the LUSC cancer type. The dashed line indicates the boundary of the top 5% association score. The top 3 associated TFs and the TF family members=(dots in red) that are associated with that specific motif are labeled in the plot"}
load("result/getTF.hypo.TFs.with.motif.pvalue.rda")
motif <- "P73_HUMAN.H10MO.A"
TF.rank.plot(motif.pvalue = TF.meth.cor, 
             motif = "P73_HUMAN.H10MO.A",
             save = FALSE) 
```

```{r,eval=TRUE,fig.cap="Shown are TF ranking plots based on the score (-log(P value)) of association between TF expression and DNA methylation of the TP53 motif in the LUSC cancer type. The dashed line indicates the boundary of the top 5% association score. The top 3 associated TFs and the TF sub-family members=(dots in red) that are associated with that specific motif are labeled in the plot"}
load("result/getTF.hypo.TFs.with.motif.pvalue.rda")
motif <- "P73_HUMAN.H10MO.A"
TF.rank.plot(motif.pvalue=TF.meth.cor,  
            motif=motif, 
            TF.label=createMotifRelevantTfs("subfamily")[motif],
            save=FALSE)
```

# Session Information

******
```{r sessionInfo}
sessionInfo()
```

# References
